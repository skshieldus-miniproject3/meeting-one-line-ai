"""OpenAIë¥¼ ì´ìš©í•œ íšŒì˜ë¡ ìš”ì•½ ë° ë¬¸ì„œ ìƒì„±"""

import os
import logging
from typing import Optional
from openai import OpenAI


class ReportGeneratorError(Exception):
    """Report Generator ì˜¤ë¥˜"""
    pass


class ReportGenerator:
    """OpenAI LLMì„ ì´ìš©í•œ ìš”ì•½ ë° ë¬¸ì„œ ìƒì„±ê¸°"""

    def __init__(self, api_key: Optional[str] = None, model: str = "gpt-4o-mini"):
        """
        ReportGenerator ì´ˆê¸°í™”

        Args:
            api_key: OpenAI API í‚¤ (Noneì´ë©´ í™˜ê²½ë³€ìˆ˜ì—ì„œ ë¡œë“œ)
            model: ì‚¬ìš©í•  OpenAI ëª¨ë¸ (ê¸°ë³¸: gpt-4o-mini)
        """
        self.api_key = api_key or os.getenv("OPENAI_API_KEY")
        if not self.api_key:
            raise ReportGeneratorError("OPENAI_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. .env íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.")

        self.model = model
        self.client = OpenAI(api_key=self.api_key)
        self.logger = logging.getLogger(__name__)

    def _call_llm(self, system_prompt: str, user_prompt: str, temperature: float = 0.3) -> str:
        """
        LLM í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜

        Args:
            system_prompt: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
            user_prompt: ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸
            temperature: ì°½ì˜ì„± ìˆ˜ì¤€ (0.0-1.0)

        Returns:
            LLM ì‘ë‹µ í…ìŠ¤íŠ¸

        Raises:
            ReportGeneratorError: API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ
        """
        try:
            response = self.client.chat.completions.create(
                model=self.model,
                messages=[
                    {"role": "system", "content": system_prompt},
                    {"role": "user", "content": user_prompt}
                ],
                temperature=temperature,
                max_tokens=4000
            )
            return response.choices[0].message.content.strip()
        except Exception as e:
            self.logger.error(f"OpenAI API í˜¸ì¶œ ì˜¤ë¥˜: {e}")
            raise ReportGeneratorError(f"LLM í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")

    # --- [ê¸°ì¡´ 5ê°œ ê¸°ëŠ¥] ---

    def summarize(self, transcript: str) -> str:
        """
        ëŒ€í™”ë¡ í…ìŠ¤íŠ¸ë¥¼ í•µì‹¬ ìš”ì•½í•©ë‹ˆë‹¤. (ê¸°ì¡´ ê¸°ëŠ¥)
        """
        self.logger.info("ëŒ€í™”ë¡ ìš”ì•½ ìƒì„± ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ë¡ì„ ì „ë¬¸ì ìœ¼ë¡œ ìš”ì•½í•˜ëŠ” ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.
        ë‹¤ìŒ ì§€ì¹¨ì„ ë”°ë¼ ìš”ì•½í•´ì£¼ì„¸ìš”:
        1. í•µì‹¬ ë‚´ìš©ì„ 3-5ê°œì˜ ê¸€ë¨¸ë¦¬ ê¸°í˜¸ë¡œ ì •ë¦¬
        2. ì¤‘ìš”í•œ ê²°ì •ì‚¬í•­ì´ë‚˜ í•©ì˜ì‚¬í•­ ê°•ì¡°
        3. êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ë‚˜ ë‚ ì§œê°€ ìˆë‹¤ë©´ í¬í•¨
        4. ê°„ê²°í•˜ê³  ëª…í™•í•œ í‘œí˜„ ì‚¬ìš©"""

        user_prompt = f"""
ë‹¤ìŒì€ í™”ìë³„ë¡œ êµ¬ë¶„ëœ íšŒì˜ë¡ í…ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
ì´ ëŒ€í™”ì˜ í•µì‹¬ ë‚´ìš©ì„ 3-5ì¤„ì˜ ê¸€ë¨¸ë¦¬ ê¸°í˜¸(â€¢)ë¡œ ìš”ì•½í•´ ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ìš”ì•½:
"""
        return self._call_llm(system_prompt, user_prompt)

    def generate_meeting_notes(self, transcript: str) -> str:
        """
        ëŒ€í™”ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ê³µì‹ íšŒì˜ë¡ ë¬¸ì„œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ê¸°ëŠ¥)
        """
        self.logger.info("ê³µì‹ íšŒì˜ë¡ ë¬¸ì„œ ìƒì„± ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê³µì‹ì ì¸ íšŒì˜ë¡(Meeting Minutes)ì„ ì‘ì„±í•˜ëŠ” ì „ë¬¸ ë¹„ì„œì…ë‹ˆë‹¤.
        ë‹¤ìŒ í˜•ì‹ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì—¬ ë¬¸ì„œë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”:

        ## íšŒì˜ë¡

        ### 1. ì£¼ìš” ì•ˆê±´
        - (ëŒ€í™”ì—ì„œ ë…¼ì˜ëœ í•µì‹¬ ì£¼ì œë“¤ì„ ë‚˜ì—´)

        ### 2. ê²°ì • ì‚¬í•­
        - (ëŒ€í™”ë¥¼ í†µí•´ í•©ì˜ë˜ê±°ë‚˜ ê²°ì •ëœ ë‚´ìš©ë“¤)

        ### 3. í–¥í›„ ì¡°ì¹˜ ì‚¬í•­ (Action Items)
        - (íŠ¹ì • ë‹´ë‹¹ìì—ê²Œ í• ë‹¹ëœ ì—…ë¬´ë‚˜ í–¥í›„ ê³„íš)

        ### 4. ê¸°íƒ€ ì‚¬í•­
        - (ì¶”ê°€ì ì¸ ë…¼ì˜ ì‚¬í•­ì´ë‚˜ ì°¸ê³  ë‚´ìš©)

        ì „ë¬¸ì ì´ê³  ê³µì‹ì ì¸ ë¬¸ì²´ë¥¼ ì‚¬ìš©í•˜ë©°, êµ¬ì²´ì ì¸ ë‚´ìš©ì„ í¬í•¨í•´ì£¼ì„¸ìš”."""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê³µì‹ íšŒì˜ë¡ ë¬¸ì„œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ê³µì‹ íšŒì˜ë¡:
"""
        return self._call_llm(system_prompt, user_prompt)

    def generate_action_items(self, transcript: str) -> str:
        """
        ëŒ€í™”ë¡ì—ì„œ ì•¡ì…˜ ì•„ì´í…œì„ ì¶”ì¶œí•©ë‹ˆë‹¤. (ê¸°ì¡´ ê¸°ëŠ¥)
        """
        self.logger.info("ì•¡ì…˜ ì•„ì´í…œ ì¶”ì¶œ ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ë‚´ìš©ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì•¡ì…˜ ì•„ì´í…œì„ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ë‹¤ìŒ ê¸°ì¤€ì— ë”°ë¼ ì•¡ì…˜ ì•„ì´í…œì„ ì‹ë³„í•´ì£¼ì„¸ìš”:
        1. êµ¬ì²´ì ì¸ í–‰ë™ì´ í•„ìš”í•œ í•­ëª©
        2. ë‹´ë‹¹ìê°€ ëª…ì‹œë˜ê±°ë‚˜ ì¶”ì • ê°€ëŠ¥í•œ í•­ëª©
        3. ê¸°í•œì´ ìˆê±°ë‚˜ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í•­ëª©"""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ì•¡ì…˜ ì•„ì´í…œì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.
ê° í•­ëª©ì— ëŒ€í•´ [ë‹´ë‹¹ì] ì‘ì—…ë‚´ìš© í˜•íƒœë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ì•¡ì…˜ ì•„ì´í…œ:
"""
        return self._call_llm(system_prompt, user_prompt)

    def analyze_sentiment(self, transcript: str) -> str:
        """
        íšŒì˜ ë¶„ìœ„ê¸°ì™€ ì°¸ì„ìë“¤ì˜ ê°ì •ì„ ë¶„ì„í•©ë‹ˆë‹¤. (ê¸°ì¡´ ê¸°ëŠ¥)
        """
        self.logger.info("íšŒì˜ ë¶„ìœ„ê¸° ë¶„ì„ ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ë¶„ìœ„ê¸°ì™€ ì°¸ì„ìë“¤ì˜ ê°ì •ì„ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ëŒ€í™”ì˜ í†¤, ì˜ê²¬ ì¶©ëŒ, í•©ì˜ ì •ë„, ì „ë°˜ì ì¸ ë¶„ìœ„ê¸°ë¥¼ ê°ê´€ì ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”."""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì˜ ë¶„ìœ„ê¸°ì™€ ì°¸ì„ìë“¤ì˜ ê°ì •ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ë¶„ì„ ê²°ê³¼:
"""
        return self._call_llm(system_prompt, user_prompt, temperature=0.1)

    def generate_follow_up_questions(self, transcript: str) -> str:
        """
        íšŒì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í›„ì† ì§ˆë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤. (ê¸°ì¡´ ê¸°ëŠ¥)
        """
        self.logger.info("í›„ì† ì§ˆë¬¸ ìƒì„± ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ í›„ì† ë…¼ì˜ê°€ í•„ìš”í•œ ì§ˆë¬¸ë“¤ì„ ìƒì„±í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ë¯¸í•´ê²° ì´ìŠˆ, ì¶”ê°€ ê²€í† ê°€ í•„ìš”í•œ ì‚¬í•­, ëª…í™•í™”ê°€ í•„ìš”í•œ ë‚´ìš©ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§ˆë¬¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”."""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì„ ë¶„ì„í•˜ì—¬ í›„ì† íšŒì˜ë‚˜ ê°œë³„ ë…¼ì˜ì—ì„œ ë‹¤ë¤„ì•¼ í•  ì§ˆë¬¸ë“¤ì„ ìƒì„±í•´ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

í›„ì† ì§ˆë¬¸:
"""
        return self._call_llm(system_prompt, user_prompt)

    # --- [ì‹ ê·œ ê¸°ëŠ¥ 6ê°œ (Git + Local Merge)] ---

    def extract_keywords(self, transcript: str) -> str:
        """
        ëŒ€í™”ë¡ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤. (Git 'e319...' ë²„ì „ ê¸°ì¤€)
        """
        self.logger.info("í•µì‹¬ í‚¤ì›Œë“œ ì¶”ì¶œ ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ë‹¤ìŒ ê·œì¹™ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•˜ì—¬ í‚¤ì›Œë“œë§Œ ì¶”ì¶œí•˜ì„¸ìš”:
1. ì •í™•íˆ 10ê°œì˜ í‚¤ì›Œë“œë§Œ ì¶”ì¶œ
2. ê° í‚¤ì›Œë“œëŠ” 30ì ì´ë‚´ì˜ ì§§ì€ ë‹¨ì–´ ë˜ëŠ” êµ¬ë¬¸
3. ì¤‘ë³µ ê¸ˆì§€
4. ì„¤ëª…ë¬¸, ì™„ì „í•œ ë¬¸ì¥ ê¸ˆì§€
5. í•œ ì¤„ì— í•˜ë‚˜ì˜ í‚¤ì›Œë“œë§Œ ì¶œë ¥ (ì•ì— - ê¸°í˜¸ ë¶™ì´ê¸°)
6. ì¹´í…Œê³ ë¦¬ í—¤ë”ë‚˜ ì¶”ê°€ ì„¤ëª… ê¸ˆì§€"""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ê°€ì¥ ì¤‘ìš”í•œ í‚¤ì›Œë“œ 10ê°œë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.

íšŒì˜ë¡:
{transcript}

ì¶œë ¥ í˜•ì‹ (ë°˜ë“œì‹œ ì´ í˜•ì‹ë§Œ ì‚¬ìš©):
- í‚¤ì›Œë“œ1
- í‚¤ì›Œë“œ2
- í‚¤ì›Œë“œ3
...
"""
        return self._call_llm(system_prompt, user_prompt)

    def classify_topics(self, transcript: str) -> str:
        """
        ëŒ€í™”ë¡ì˜ ì£¼ì œë¥¼ ë¶„ë¥˜í•˜ê³  ì¹´í…Œê³ ë¦¬í™”í•©ë‹ˆë‹¤. (Git 'e319...' ë²„ì „ ì‹ ê·œ)
        """
        self.logger.info("ì£¼ì œ ë¶„ë¥˜ ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ë‚´ìš©ì„ ì£¼ì œë³„ë¡œ ë¶„ë¥˜í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ëŒ€í™”ë¡ì„ ì½ê³  ë‹¤ìŒ ì‘ì—…ì„ ìˆ˜í–‰í•´ì£¼ì„¸ìš”:
        1. ë…¼ì˜ëœ ì£¼ìš” ì£¼ì œë“¤ì„ ì‹ë³„
        2. ê° ì£¼ì œì— ëŒ€í•œ ì¤‘ìš”ë„ í‰ê°€
        3. ì£¼ì œ ê°„ ì—°ê´€ê´€ê³„ íŒŒì•…
        4. ê° ì£¼ì œë³„ ë…¼ì˜ ë¹„ì¤‘ ì¶”ì •"""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì˜ ì£¼ì œë¥¼ ë¶„ë¥˜í•˜ê³  ë¶„ì„í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

**ì£¼ìš” ì£¼ì œ ë¶„ë¥˜**:
1. [ì£¼ì œëª…] (ì¤‘ìš”ë„: ë†’ìŒ/ì¤‘ê°„/ë‚®ìŒ)
   - ë…¼ì˜ ë‚´ìš© ìš”ì•½
   - ì „ì²´ ëŒ€í™”ì—ì„œ ì°¨ì§€í•˜ëŠ” ë¹„ì¤‘: XX%

**ì£¼ì œ ê°„ ì—°ê´€ê´€ê³„**:
- (ì£¼ì œë“¤ì´ ì–´ë–»ê²Œ ì—°ê²°ë˜ëŠ”ì§€ ì„¤ëª…)

**ìš°ì„ ìˆœìœ„ ìˆœì„œ**:
1. (ê°€ì¥ ì¤‘ìš”í•œ ì£¼ì œë¶€í„° ë‚˜ì—´)

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ì£¼ì œ ë¶„ë¥˜:
"""
        return self._call_llm(system_prompt, user_prompt)

    def analyze_by_speaker(self, transcript: str) -> str:
        """
        ë°œì–¸ìë³„ë¡œ ë‚´ìš©ì„ ìš”ì•½í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤. (Git 'e319...' ë²„ì „ ì‹ ê·œ)
        """
        self.logger.info("ë°œì–¸ìë³„ ë¶„ì„ ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ì°¸ì„ìë“¤ì˜ ë°œì–¸ì„ ë¶„ì„í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ê° í™”ìë³„ë¡œ ë‹¤ìŒì„ ë¶„ì„í•´ì£¼ì„¸ìš”:
        1. ì£¼ìš” ë°œì–¸ ë‚´ìš© ìš”ì•½
        2. ì „ë¬¸ ë¶„ì•¼ ë˜ëŠ” ì—­í•  ì¶”ì •
        3. ì˜ê²¬ì˜ ë°©í–¥ì„± (ì°¬ì„±/ë°˜ëŒ€/ì¤‘ë¦½)
        4. ì£¼ë„ì„± ì •ë„ (ì ê·¹ì /ë³´í†µ/ì†Œê·¹ì )
        5. í•µì‹¬ ê¸°ì—¬ ì‚¬í•­"""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì—ì„œ ê° í™”ìë³„ë¡œ ë°œì–¸ì„ ë¶„ì„í•´ì£¼ì„¸ìš”.

ê° í™”ìë§ˆë‹¤ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

**í™”ì [ë²ˆí˜¸]**:
- **ì£¼ìš” ë°œì–¸ ë‚´ìš©**: (í•µì‹¬ ë‚´ìš© 2-3ì¤„ ìš”ì•½)
- **ì¶”ì • ì—­í• **: (ê¸°ìˆ íŒ€, ê´€ë¦¬ì, ë§ˆì¼€íŒ… ë“±)
- **ì˜ê²¬ ë°©í–¥ì„±**: (ê¸ì •ì /ë¶€ì •ì /ì¤‘ë¦½ì /í˜¼í•©)
- **ì°¸ì—¬ë„**: (ì ê·¹ì /ë³´í†µ/ì†Œê·¹ì )
- **í•µì‹¬ ê¸°ì—¬**: (ì´ ì‚¬ëŒì´ íšŒì˜ì— ê¸°ì—¬í•œ í•µì‹¬ ë‚´ìš©)

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ë°œì–¸ìë³„ ë¶„ì„:
"""
        return self._call_llm(system_prompt, user_prompt, temperature=0.2)

    def classify_meeting_type(self, transcript: str) -> str:
        """
        íšŒì˜ ìœ í˜•ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤. (Git 'e319...' ë²„ì „ ì‹ ê·œ)
        """
        self.logger.info("íšŒì˜ ìœ í˜• ë¶„ë¥˜ ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ìœ í˜•ì„ ë¶„ì„í•˜ê³  ë¶„ë¥˜í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ ì¤‘ì—ì„œ ê°€ì¥ ì í•©í•œ ìœ í˜•ì„ ì„ íƒí•˜ê³  ê·¸ ê·¼ê±°ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”:

        **íšŒì˜ ìœ í˜• ì¹´í…Œê³ ë¦¬**:
        1. í”„ë¡œì íŠ¸ í‚¥ì˜¤í”„ - ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ ì‹œì‘
        2. ì •ê¸° ì§„í–‰ íšŒì˜ - ì£¼ê°„/ì›”ê°„ ì •ê¸° ë¯¸íŒ…
        3. ë¸Œë ˆì¸ìŠ¤í† ë° - ì•„ì´ë””ì–´ ë°œì‚° ì„¸ì…˜
        4. ì˜ì‚¬ê²°ì • íšŒì˜ - ì¤‘ìš”í•œ ê²°ì •ì„ ë‚´ë¦¬ëŠ” íšŒì˜
        5. ë¬¸ì œ í•´ê²° íšŒì˜ - íŠ¹ì • ë¬¸ì œ í•´ê²° ë…¼ì˜
        6. ë³´ê³ /ê³µìœ  íšŒì˜ - ì •ë³´ ì „ë‹¬ ë° ê³µìœ 
        7. ê³„íš ìˆ˜ë¦½ íšŒì˜ - ì „ëµ/ê³„íš ìˆ˜ë¦½
        8. ê²€í† /í”¼ë“œë°± íšŒì˜ - ê²°ê³¼ë¬¼ ê²€í† 
        9. êµìœ¡/í•™ìŠµ ì„¸ì…˜ - ì§€ì‹ ì „ë‹¬
        10. ê¸°íƒ€ - ìœ„ ì¹´í…Œê³ ë¦¬ì— í•´ë‹¹í•˜ì§€ ì•ŠëŠ” ê²½ìš°"""

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì„ ë¶„ì„í•˜ì—¬ íšŒì˜ ìœ í˜•ì„ ë¶„ë¥˜í•´ì£¼ì„¸ìš”.

ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”:

**íšŒì˜ ìœ í˜•**: [ì„ íƒí•œ ì¹´í…Œê³ ë¦¬]

**ì£¼ ì¹´í…Œê³ ë¦¬ ì‹ ë¢°ë„**: XX%

**ë¶€ ì¹´í…Œê³ ë¦¬** (í•´ë‹¹ë˜ëŠ” ê²½ìš°):
- [ì¶”ê°€ ì¹´í…Œê³ ë¦¬] (XX%)

**ë¶„ë¥˜ ê·¼ê±°**:
- (ì´ ìœ í˜•ìœ¼ë¡œ ë¶„ë¥˜í•œ ì´ìœ ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª…)

**íšŒì˜ íŠ¹ì§•**:
- ì°¸ì—¬ì êµ¬ì„±: (ê²½ì˜ì§„/ì‹¤ë¬´ì/í˜¼í•©)
- ì§„í–‰ ë°©ì‹: (êµ¬ì¡°ì /ììœ ë¡œìš´/í˜¼í•©)
- ì˜ì‚¬ê²°ì • ì—¬ë¶€: (ìˆìŒ/ì—†ìŒ/ë³´ë¥˜)

--- [íšŒì˜ë¡] ---
{transcript}
----------------

íšŒì˜ ìœ í˜• ë¶„ë¥˜:
"""
        return self._call_llm(system_prompt, user_prompt, temperature=0.1)

    def summarize_by_speaker(self, transcript: str) -> str:
        """
        ëŒ€í™”ë¡ì„ ë°”íƒ•ìœ¼ë¡œ í™”ìë³„ ì£¼ìš” ë°œì–¸ì„ ìš”ì•½í•©ë‹ˆë‹¤. (ë¡œì»¬ DB ë²„ì „ ì‹ ê·œ)
        (analyze_by_speakerë³´ë‹¤ ê°„ë‹¨í•œ ìš”ì•½ë³¸)
        """
        self.logger.info("í™”ìë³„ ê°„ë‹¨ ìš”ì•½ ìƒì„± ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ê° í™”ìì˜ ì£¼ìš” ì…ì¥ì´ë‚˜ ë°œì–¸ì„ ìš”ì•½í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
        [í™”ì N] í˜•íƒœë¡œ êµ¬ë¶„ëœ ëŒ€í™”ë¡ì„ ë³´ê³ , ê° í™”ìë³„ë¡œ í•µì‹¬ ì£¼ì¥ì„ 1~2ì¤„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.
        ëª¨ë“  í™”ìë¥¼ í¬í•¨í•  í•„ìš”ëŠ” ì—†ìœ¼ë©°, ì¤‘ìš” ë°œì–¸ì„ í•œ í™”ì ì¤‘ì‹¬ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.

        [ì¶œë ¥ í˜•ì‹]
        - [í™”ì 1]: (í™”ì 1ì˜ í•µì‹¬ ë°œì–¸ ìš”ì•½)
        - [í™”ì 2]: (í™”ì 2ì˜ í•µì‹¬ ë°œì–¸ ìš”ì•½)
        """

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì„ í™”ìë³„ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

í™”ìë³„ ìš”ì•½:
"""
        return self._call_llm(system_prompt, user_prompt)

    def calculate_engagement_score(self, transcript: str) -> str:
        """
        íšŒì˜ ì°¸ì—¬ë„ë¥¼ ì ìˆ˜í™”í•˜ê³  ë¶„ì„í•©ë‹ˆë‹¤.

        Args:
            transcript: ëŒ€í™”ë¡ í…ìŠ¤íŠ¸ (í™”ìë³„ë¡œ êµ¬ë¶„ëœ í˜•íƒœ)

        Returns:
            ì°¸ì—¬ë„ ì ìˆ˜ ë¶„ì„ ê²°ê³¼ (JSON í˜•ì‹ ë¬¸ìì—´)
            - overall_score: ì „ì²´ ì°¸ì—¬ë„ ì ìˆ˜ (0-100)
            - speaker_scores: í™”ìë³„ ì ìˆ˜
            - engagement_distribution: ì°¸ì—¬ ê· í˜•ë„
            - key_insights: ì£¼ìš” ë°œê²¬ì‚¬í•­

        Raises:
            ReportGeneratorError: ì ìˆ˜ ê³„ì‚° ì‹¤íŒ¨ ì‹œ
        """
        self.logger.info("íšŒì˜ ì°¸ì—¬ë„ ì ìˆ˜ ê³„ì‚° ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íšŒì˜ ì°¸ì—¬ë„ë¥¼ í‰ê°€í•˜ëŠ” ì „ë¬¸ ë¶„ì„ê°€ì…ë‹ˆë‹¤.
        íšŒì˜ë¡ì„ ë¶„ì„í•˜ì—¬ ì°¸ì—¬ë„ë¥¼ ì •ëŸ‰ì ìœ¼ë¡œ í‰ê°€í•˜ê³  ì ìˆ˜í™”í•˜ì„¸ìš”.

        [í‰ê°€ ê¸°ì¤€]
        1. ë°œì–¸ ë¹ˆë„ì™€ ì‹œê°„ ë¶„í¬ (30ì )
        2. ë°œì–¸ì˜ ì§ˆê³¼ ê¸°ì—¬ë„ (40ì )
        3. ì°¸ì—¬ ê· í˜•ë„ (30ì )

        [ì¶œë ¥ í˜•ì‹ - JSON]
        {
            "overall_score": 85,
            "speaker_scores": {
                "í™”ì1": {"score": 90, "ë°œì–¸ìˆ˜": 15, "ê¸°ì—¬ë„": "ë†’ìŒ"},
                "í™”ì2": {"score": 75, "ë°œì–¸ìˆ˜": 10, "ê¸°ì—¬ë„": "ì¤‘ê°„"}
            },
            "engagement_distribution": "ê· í˜•ì " ë˜ëŠ” "ë¶ˆê· í˜•",
            "participation_balance": 80,
            "key_insights": [
                "í™”ì1ì´ ê°€ì¥ í™œë°œí•˜ê²Œ ì°¸ì—¬",
                "í™”ì3ì˜ ì°¸ì—¬ë„ ê°œì„  í•„ìš”"
            ]
        }
        """

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì„ ë¶„ì„í•˜ì—¬ ì°¸ì—¬ë„ë¥¼ ì ìˆ˜í™”í•˜ê³  JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ì°¸ì—¬ë„ ì ìˆ˜ ë¶„ì„:
"""
        return self._call_llm(system_prompt, user_prompt, temperature=0.2)

    def generate_improvement_suggestions(self, transcript: str) -> str:
        """
        íšŒì˜ ê°œì„ ì„ ìœ„í•œ êµ¬ì²´ì ì¸ ì œì•ˆì„ ìƒì„±í•©ë‹ˆë‹¤.

        Args:
            transcript: ëŒ€í™”ë¡ í…ìŠ¤íŠ¸ (í™”ìë³„ë¡œ êµ¬ë¶„ëœ í˜•íƒœ)

        Returns:
            íšŒì˜ ê°œì„  ì œì•ˆ (êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸)
            - íšŒì˜ ì§„í–‰ ë°©ì‹ ê°œì„ 
            - ì‹œê°„ ê´€ë¦¬ ê°œì„ 
            - ì°¸ì—¬ë„ í–¥ìƒ ë°©ì•ˆ
            - ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì  ì œì•ˆ

        Raises:
            ReportGeneratorError: ì œì•ˆ ìƒì„± ì‹¤íŒ¨ ì‹œ
        """
        self.logger.info("íšŒì˜ ê°œì„  ì œì•ˆ ìƒì„± ì¤‘...")

        system_prompt = """ë‹¹ì‹ ì€ íš¨ê³¼ì ì¸ íšŒì˜ ì§„í–‰ì„ ìœ„í•œ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
        íšŒì˜ë¡ì„ ë¶„ì„í•˜ì—¬ ì‹¤í–‰ ê°€ëŠ¥í•œ êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆì„ ì œê³µí•˜ì„¸ìš”.

        [ë¶„ì„ ì˜ì—­]
        1. íšŒì˜ ì§„í–‰ ë°©ì‹ (ì˜ì‚¬ê²°ì •, ì£¼ì œ ê´€ë¦¬)
        2. ì‹œê°„ ê´€ë¦¬ (ì£¼ì œë³„ ì‹œê°„ ë°°ë¶„)
        3. ì°¸ì—¬ë„ í–¥ìƒ (ì†Œê·¹ì  ì°¸ì—¬ì ë…ë ¤)
        4. ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ íš¨ìœ¨ì„±

        [ì¶œë ¥ í˜•ì‹]
        ## ğŸ¯ ì¢…í•© í‰ê°€
        (íšŒì˜ì˜ ì „ë°˜ì ì¸ í‰ê°€)

        ## ğŸ’¡ ì£¼ìš” ê°œì„  ì œì•ˆ
        1. [êµ¬ì²´ì  ì œì•ˆ 1]
           - í˜„ì¬ ë¬¸ì œ: (ë¬¸ì œì  ì„¤ëª…)
           - ê°œì„  ë°©ì•ˆ: (ì‹¤í–‰ ê°€ëŠ¥í•œ ë°©ë²•)
           - ê¸°ëŒ€ íš¨ê³¼: (ê°œì„  ì‹œ íš¨ê³¼)

        2. [êµ¬ì²´ì  ì œì•ˆ 2]
           ...

        ## ğŸ“Š ë‹¤ìŒ íšŒì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸
        - [ ] (ì‹¤í–‰ í•­ëª© 1)
        - [ ] (ì‹¤í–‰ í•­ëª© 2)
        """

        user_prompt = f"""
ë‹¤ìŒ íšŒì˜ë¡ì„ ë¶„ì„í•˜ì—¬ êµ¬ì²´ì ì´ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ê°œì„  ì œì•ˆì„ ì œê³µí•´ì£¼ì„¸ìš”.

--- [íšŒì˜ë¡] ---
{transcript}
----------------

ê°œì„  ì œì•ˆ:
"""
        return self._call_llm(system_prompt, user_prompt, temperature=0.4)

    # --- [ì„ë² ë”© ê¸°ëŠ¥] ---

    def generate_embedding(self, text: str) -> list[float]:
        """
        í…ìŠ¤íŠ¸ë¥¼ ì„ë² ë”© ë²¡í„°ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

        Args:
            text: ì„ë² ë”©ìœ¼ë¡œ ë³€í™˜í•  í…ìŠ¤íŠ¸

        Returns:
            1536ê°œì˜ ì‹¤ìˆ˜ë¡œ ì´ë£¨ì–´ì§„ ì„ë² ë”© ë²¡í„°

        Raises:
            ReportGeneratorError: ì„ë² ë”© ìƒì„± ì‹¤íŒ¨ ì‹œ
        """
        try:
            response = self.client.embeddings.create(
                model="text-embedding-3-small",
                input=text
            )
            return response.data[0].embedding
        except Exception as e:
            self.logger.error(f"ì„ë² ë”© ìƒì„± ì˜¤ë¥˜: {e}")
            raise ReportGeneratorError(f"ì„ë² ë”© ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")