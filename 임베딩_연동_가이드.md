# 임베딩 자동 생성 및 업데이트 연동 가이드

백엔드 팀원용 - AI 서버 임베딩 기능 연동 방법

---

## 1. 개요

AI 서버에서 자동으로 임베딩을 생성하고 업데이트하는 기능이 추가되었습니다.

### 임베딩 생성 시점

1. **업로드 시 (자동)** - 오디오 파일 업로드 후 AI 분석 시 임베딩 자동 생성
2. **수정 시 (수동 호출)** - 백엔드에서 회의록 수정 후 AI 서버 API 호출

---

## 2. 업로드 시 자동 임베딩 생성 ✅

### 플로우

```
사용자 → 프론트엔드 → 백엔드 (파일 저장)
    ↓
백엔드 → AI 서버 POST /ai/analyze
    ↓
AI 서버 (background_analysis_task):
  1. STT 실행 ✅
  2. 요약 생성 ✅
  3. 키워드 추출 ✅
  4. 임베딩 생성 및 저장 ✅ (새로 추가됨!)
  5. 화자 분리 ✅
    ↓
AI 서버 → 백엔드 POST /api/meetings/{id}/callback
```

### 백엔드 작업

**작업 불필요!** 기존 `/ai/analyze` API 호출 방식 그대로 사용하면 자동으로 임베딩이 생성됩니다.

---

## 3. 회의록 수정 시 임베딩 업데이트

### 3.1 AI 서버 API

**엔드포인트:** `PUT /embeddings/{meeting_id}`

**요청:**
```http
PUT http://localhost:8000/embeddings/{meeting_id}
Content-Type: application/json

{
  "summary": "수정된 요약문",
  "title": "수정된 제목" // 선택사항
}
```

**응답 (성공):**
```json
{
  "status": "success",
  "message": "임베딩이 업데이트되었습니다: {meeting_id}"
}
```

**응답 (실패):**
```json
{
  "detail": "임베딩 업데이트 실패: {오류 메시지}"
}
```

---

### 3.2 백엔드 구현

#### MeetingController.java 수정

```java
@PutMapping("/{meetingId}")
public ResponseEntity<MeetingDto> updateMeeting(
    @PathVariable UUID meetingId,
    @RequestBody UpdateMeetingRequest request,
    @AuthenticationPrincipal UUID userId
) {
    // 1. DB 업데이트
    MeetingDto updated = meetingService.updateMeeting(meetingId, request, userId);

    // 2. AI 서버에 임베딩 업데이트 요청
    // 요약이나 제목이 수정된 경우에만 호출
    if (request.getSummary() != null || request.getTitle() != null) {
        meetingService.updateEmbedding(
            meetingId,
            updated.getSummary(),
            updated.getTitle()
        );
    }

    return ResponseEntity.ok(updated);
}
```

#### MeetingService.java에 메서드 추가

```java
@Async  // 비동기 권장 (응답 기다리지 않음)
public void updateEmbedding(UUID meetingId, String summary, String title) {
    if (summary == null || summary.isEmpty()) {
        log.debug("요약이 없어 임베딩 업데이트를 건너뜁니다: {}", meetingId);
        return;
    }

    try {
        String aiServerUrl = env.getProperty("ai.server.url") + "/embeddings/" + meetingId;

        Map<String, Object> requestBody = new HashMap<>();
        requestBody.put("summary", summary);
        if (title != null && !title.isEmpty()) {
            requestBody.put("title", title);
        }

        // RestTemplate으로 PUT 요청
        restTemplate.put(aiServerUrl, requestBody);

        log.info("임베딩 업데이트 요청 전송 완료: {}", meetingId);
    } catch (Exception e) {
        // 임베딩 업데이트 실패해도 회의록 수정은 성공으로 처리
        log.warn("임베딩 업데이트 실패 (검색 정확도에만 영향): {}", e.getMessage());
    }
}
```

#### application.yml 설정 (이미 있으면 스킵)

```yaml
ai:
  server:
    url: http://localhost:8000  # 개발 환경
    # url: http://ai-server:8000  # 프로덕션
    timeout: 10000  # 10초
```

---

## 4. 전체 플로우 정리

### 4.1 회의록 생성 (업로드)

```
사용자: 오디오 업로드
    ↓
백엔드: 파일 저장 → AI 서버 POST /ai/analyze
    ↓
AI 서버:
  - STT 실행
  - 요약 생성
  - 키워드 추출
  - 임베딩 생성 ✅ (자동)
  - 화자 분리
    ↓
백엔드: DB 저장 (콜백 수신)
    ↓
완료!
```

### 4.2 회의록 수정

```
사용자: 프론트에서 요약/제목 수정
    ↓
백엔드: DB 업데이트 → AI 서버 PUT /embeddings/{id}
    ↓
AI 서버: 임베딩 재생성 및 저장 ✅
    ↓
완료!
```

### 4.3 검색

```
사용자: "예산 관련 회의" 검색
    ↓
백엔드: AI 서버 POST /search/semantic
    ↓
AI 서버:
  - 검색 쿼리 임베딩 생성
  - 기존 저장된 임베딩들과 비교 (최신 수정본 반영됨!)
  - 유사도 높은 순으로 정렬
    ↓
백엔드: meeting_id로 DB 조회 (본인 회의만)
    ↓
프론트: 검색 결과 표시
```

---

## 5. 주의사항

### 5.1 비동기 처리 권장

임베딩 업데이트는 **비동기**로 처리하는 것이 좋습니다.

**이유:**
- 임베딩 생성에 1~2초 소요
- 회의록 수정 응답이 느려질 수 있음
- 실패해도 회의록 수정 자체는 성공 처리

**구현:**
```java
@Async
public void updateEmbedding(...) {
    // 비동기 실행
}
```

### 5.2 에러 처리

임베딩 업데이트 실패 시:
- ✅ 회의록 수정은 성공으로 처리
- ⚠️ 로그만 기록
- 📌 검색 정확도만 일시적으로 낮아짐

```java
try {
    restTemplate.put(...);
} catch (Exception e) {
    log.warn("임베딩 업데이트 실패: {}", e.getMessage());
    // 예외를 던지지 않음
}
```

### 5.3 타임아웃 설정

```java
SimpleClientHttpRequestFactory factory = new SimpleClientHttpRequestFactory();
factory.setConnectTimeout(10000);  // 10초
factory.setReadTimeout(10000);     // 10초
RestTemplate restTemplate = new RestTemplate(factory);
```

---

## 6. 테스트 시나리오

### 6.1 업로드 후 임베딩 생성 확인

```bash
# 1. 오디오 파일 업로드 (프론트/백엔드 통해서)
# 2. AI 서버 로그 확인
cd C:/project/meeting-one-line/meeting-one-line-ai/stt-ncp
tail -f logs/server.log

# 예상 로그:
# [Task meeting_123] 임베딩 생성 및 저장 중...
# [Task meeting_123] ✅ 임베딩 저장 완료

# 3. 임베딩 파일 확인
ls embeddings/meeting_*.json
```

### 6.2 회의록 수정 후 임베딩 업데이트 확인

```bash
# 1. 백엔드 API로 회의록 수정
curl -X PUT http://localhost:8080/api/meetings/meeting_123 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer {token}" \
  -d '{
    "summary": "수정된 요약문입니다"
  }'

# 2. AI 서버 로그 확인
# 예상 로그:
# [UPDATE] 임베딩 업데이트 요청: meeting_123
# [UPDATE] ✅ 임베딩 업데이트 완료: meeting_123

# 3. 검색으로 확인
curl -X POST http://localhost:8000/search/semantic \
  -H "Content-Type: application/json" \
  -d '{
    "query": "수정된 요약문",
    "top_k": 5
  }'
# → meeting_123이 검색되어야 함
```

### 6.3 DB와 임베딩 동기화 확인

```bash
# 1. DB에서 요약 수정
UPDATE meetings SET summary = '새로운 요약' WHERE id = 'meeting_123';

# 2. 임베딩 업데이트 API 호출
curl -X PUT http://localhost:8000/embeddings/meeting_123 \
  -H "Content-Type: application/json" \
  -d '{
    "summary": "새로운 요약"
  }'

# 3. 검색 테스트
# → "새로운 요약"으로 검색 시 meeting_123이 나와야 함
```

---

## 7. FAQ

**Q: 임베딩 업데이트를 안 하면 어떻게 되나요?**
- A: 검색 시 수정 전 내용으로 검색됩니다. DB와 임베딩이 동기화되지 않습니다.

**Q: 임베딩 업데이트가 실패하면?**
- A: 회의록 수정은 성공 처리됩니다. 임베딩만 업데이트 안 되고 로그만 남습니다.

**Q: 제목만 수정하면 임베딩도 업데이트해야 하나요?**
- A: 검색은 주로 요약(summary)으로 하므로, 제목만 바뀌면 임베딩 업데이트를 스킵해도 됩니다.

**Q: 오디오 파일만 업로드하고 요약이 없으면?**
- A: 임베딩이 생성되지 않습니다. 검색 결과에 나오지 않습니다.

**Q: 임베딩 파일을 수동으로 삭제하면?**
- A: 검색 결과에서 해당 회의록이 제외됩니다. DB 데이터는 그대로 유지됩니다.

---

## 8. 트러블슈팅

### 문제 1: 임베딩이 생성되지 않음

**원인:**
- OpenAI API 키가 설정되지 않음
- 요약이 생성되지 않음

**해결:**
```bash
# AI 서버 .env 확인
cat .env | grep OPENAI_API_KEY

# 로그 확인
tail -f logs/server.log | grep "임베딩"
```

### 문제 2: 임베딩 업데이트 실패

**원인:**
- AI 서버가 다운됨
- meeting_id가 잘못됨

**해결:**
```bash
# AI 서버 상태 확인
curl http://localhost:8000/health

# 로그 확인
tail -f logs/server.log | grep "UPDATE"
```

### 문제 3: 검색 결과에 수정본이 반영 안 됨

**원인:**
- 임베딩 업데이트 API를 호출하지 않음
- 요청 실패

**해결:**
```bash
# 수동으로 임베딩 업데이트
curl -X PUT http://localhost:8000/embeddings/{meeting_id} \
  -H "Content-Type: application/json" \
  -d '{
    "summary": "DB의 최신 요약문"
  }'
```

---

## 9. 연락처

질문이나 문제 발생 시:
- AI 서버 담당: [본인 이름/연락처]
- 임베딩 관련 이슈: [본인 이름/연락처]
